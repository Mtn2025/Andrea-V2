# Deployment Checklist - Phase VIII

This document outlines the requirements and steps to deploy the "Asistente Andrea" application with **Post-Call Extraction** and **Transcript Persistence**.

## 1. Environment Variables
Ensure the following variables are configured in Coolify (or your `.env` for production):

### Database (Required - Critical)
```env
# Connection String (Auto-generated by Coolify usually, or manual)
DATABASE_URL=postgresql+asyncpg://user:password@host:port/dbname
```

### AI Services (Required)
```env
# Extraction & Transcription Logic
GROQ_API_KEY=gsk_...
AZURE_SPEECH_KEY=...
AZURE_SPEECH_REGION=...
```

### Telephony (One or both required)
```env
# If using Twilio
TWILIO_ACCOUNT_SID=...
TWILIO_AUTH_TOKEN=...

# If using Telnyx
TELNYX_API_KEY=...
```

## 2. Post-Deployment Actions

After deploying the new build, you **MUST** run the database migrations to create the new `transcripts` table and update the `calls` table.

**Command:**
```bash
./apply_migrations.sh
# OR manually:
alembic upgrade head
```

## 3. Health Check & Validation

### API Endpoints
- **GET /health**: Liveness (200 OK, no DB).
- **GET /api/system/health**: Readiness (DB + Redis; JSON con status, database, redis).
- **GET /api/history**: Verify history loads (verifies DB connection).
- **GET /api/history/{id}/detail**: Verify detail view (verifies Transcripts table).

Variables de entorno completas: [docs/VARIABLES_ENTORNO.md](docs/VARIABLES_ENTORNO.md). Operaci√≥n: [docs/OPERACION.md](docs/OPERACION.md).

### Feature Flags
No specific feature flags are required for this phase; the logic is built into `OrchestratorV2`.

- **Extraction**: Runs automatically when a call stops (`orch.stop()`).
- **Transcript Saving**: Runs asynchronously during the call.

## 4. Rollback Plan
If issues arise (e.g., database locks or critical bugs):

1. **Revert Migration**:
   ```bash
   alembic downgrade merge_heads_20260201
   ```
   *Note: This will drop the `transcripts` table and `extracted_data` column.*

2. **Revert Code**: Deploy the previous stable commit.
